<!doctype html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" type="text/css" href="../../_css/styles.css">

	<title>MongoDB</title>
</head>

<body>


	<nav class="navbar">
		<a href="../../index.html">Back to homepage</a>
		<a class="nav-page nav-active">MongoDB Running Commands</a>
	</nav>



	<h1>Running commands</h1>
	<h2>Start the server and Shell</h2>
	<div class="text-section">
		<p>You must first start by starting the MongoDB server. Then, open a Shell to run commands.</p>
	</div>

	<h3>Start the server</h3>
	<section class="code-section-container">
		<div class="code-text-section">
			<p>Open PowerShell.</p>
			<p>Run <span class="code">mongod.exe</span>.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">mongod.exe</span></pre>
		</div>
	</section>

	<h3>Open the Shell</h3>
	<section class="code-section-container">
		<div class="code-text-section">
			<p>Open PowerShell.</p>
			<p>Run <span class="code">mongo</span>.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">mongo</span></pre>
		</div>
	</section>

	<h3>Quit the Shell</h3>
	<section class="code-section-container">
		<div class="code-text-section">
			<p>Run <span class="code">quit()</span> when you're ready to close the Shell.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">&gt; quit()</span></pre>
		</div>
	</section>


	<h1>Database</h1>
	<h2>Create a new database</h2>
	<section class="code-section-container">
		<div class="code-text-section">
			<p>Run the <span class="code">use</span> command to create a new database or switch to an existing database.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">&gt; use natours-test
switched to db natours-test</span></pre>
		</div>
	</section>

	<h2>Show all databases</h2>
	<section class="code-section-container">
		<div class="code-text-section">
			<p>This commands lists all databases.</p>
			<p><span class="text-object">admin</span>, <span class="text-object">config</span>, and <span
					class="text-object">local</span> are default databases.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">&gt; show dbs</span></pre>
		</div>
	</section>



	<h1>Collections</h1>

	<h2>Show Collections</h2>
	<section class="code-section-container">
		<div class="code-text-section">
			<p>This command lists all Collections in a database.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">&gt; show collections</span></pre>
		</div>
	</section>






	<h1>Documents</h1>
	<h2>Create a new document</h2>
	<div class="text-section">
		<p>Creating a new document follows this syntax:</p>
		<p><span class="code-highlight">DATABASE.COLLECTION.FUNCTION("object")</span></p>
	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>The command starts with the current database. This is noted by <span class="code">db</span>.</p>
			<p>To create a new document, you must first specify a collection. In this example, <span class="code">tours</span>
				is the collection.</p>
			<p>Create a document inside of this collection using the <span class="code">insertOne()</span> function.</p>
			<p>In the <span class="code">insertOne()</span> function, pass in a JavaScript Object.</p>

		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">&gt; db.tours.insertOne({ name: "The Forest Hiker", price: 297, rating: 4.7})
{
  "acknowledged" : true,
  "insertedId" : ObjectId("61e9e02f5eb0346bcc45d3a8")
}        </span></pre>
		</div>
	</section>






	<h2>Create multiple documents</h2>
	<div class="text-section">
		<p>Use <span class="code">insertMany()</span> to insert multiple documents.</p>
		<p>This accepts an Array of multiple objects.</p>
	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>Create an Array using <span class="code">[]</span>.</p>
			<p>Add Objects within the Array.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">&gt; db.tours.insertMany([{name: "The Sea Explorer", price: 497, rating: 4.8 }, { name: "The Snow Adventurer", price: 997, rating: 4.9, difficulty: "easy"}])</span>
{
  "acknowledged" : true,
  "insertedIds" : [
    ObjectId("6254917a4b556a73e5dc893b"),
    ObjectId("6254917a4b556a73e5dc893c")
  ]
}  </pre>
		</div>
	</section>



	<h1>Querying Documents</h1>

	<h2>Query all Documents in a Collection</h2>
	<section class="code-section-container">
		<div class="code-text-section">
			<p>Use the <span class="code">find()</span> command to view all Documents in a Collection.</p>
			<p>Note how MongoDB automatically creates a unique <span class="code">ObjectId</span> for the Document.</p>
		</div>
		<div class="code-block-section-w60">
			<pre
				class="example"><span class="code-nodejs">&gt; db.tours.find()
{ "_id" : ObjectId("61e9e02f5eb0346bcc45d3a8"), "name" : "The Forest Hiker", "price" : 297, "rating" : 4.7 }</span></pre>
		</div>
	</section>



	<h2>Query a property value</h2>

	<div class="text-section">
		<p>This command returns all documents that contain the specific property value queried.</p>
	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>Add an Object into the <span class="code">find()</span> method.</p>
			<p>Pass in the filter.</p>
			<p>In this example, you are searching for the 'name' property.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">db.tours.find({ name: "The Forest Hiker" })</span>
{ "_id" : ObjectId("61e9e02f5eb0346bcc45d3a8"), "name" : "The Forest Hiker", "price" : 297, "rating" : 4.7 }</pre>
		</div>
	</section>







	<h2>Query a property value LESS THAN or EQUAL to a specific amount</h2>

	<div class="text-section">
		<p>This returns all documents where the 'price' property is LESS THAN 500.</p>
	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>Create a new Object for the value to search for surrounded by {}.</p>
			<p>Use the LESS THAN or EQUAL operator. <span class="code">$lte</span>. This is a Mongo Operator.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">db.tours.find({ price: {$lte: 500} })</span></pre>
		</div>
	</section>









	<h2>Query for multiple values</h2>

	<div class="text-section">
		<p>This returns all documents where the 'price' property is LESS THAN 500, and if the rating is greater than 4.8.
		</p>
	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>Use the LESS THAN operator to query a value.</p>
			<p>Add a comma, then the next query.</p>
			<p>The next query uses the GREATER THAN or EQUAL operator.</p>
		</div>
		<div class="code-block-section-w60">
			<pre
				class="example"><span class="code-nodejs">db.tours.find({ price: {$lt: 500}, rating: {$gte: 4.8} })</span></pre>
		</div>
	</section>





	<h2>OR query for multiple values</h2>

	<div class="text-section">
		<p>This checks if only 1 value is true.</p>
	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>Start with the <span class="code">$or</span> Operator.</p>
			<p>THis is followed by an Array.</p>
			<p>Inside the Array you add the conditions.</p>
		</div>
		<div class="code-block-section-w60">
			<pre
				class="example"><span class="code-nodejs">db.tours.find({ $or: [ {price: {$lt: 500}}, {rating: {$gte: 4.8}}  ] })</span></pre>
		</div>
	</section>







	<h2>Output only a specific property</h2>

	<div class="text-section">
		<p>This will query, but only output the 'name' property.</p>
	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>After the Array, add the property to output.</p>
		</div>
		<div class="code-block-section-w60">
			<pre
				class="example"><span class="code-nodejs">db.tours.find({ $or: [ {price: {$lt: 500}}, {rating: {$gte: 4.8}}  ] }, <span class="code-highlight">{name: 1}</span>)</span></pre>
		</div>
	</section>













	<h1>Updating Documents: CRUD</h1>

	<h2>Update a document</h2>
	<div class="text-section">
		<p>This uses <span class="code">updateOne()</span> to update a single document.</p>

	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>The first element is a filter Object. It's what you're going to update.</p>
			<p>The second element is the new value. Use <span class="code">$set</span> to update by creating a new Object.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">db.tours.updateOne({ name: "The Snow Adventurer"}, { $set: {price: 597} })</span>
{ "acknowledged" : true, "matchedCount" : 1, "modifiedCount" : 1 }</pre>
		</div>
	</section>




	<h2>Update multiple documents</h2>
	<div class="text-section">
		<p>This uses <span class="code">updateMany()</span> to update a several documents.</p>

	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>The first two elements are search for what to update.</p>
			<p>The second uses the <span class="code">$set</span> operator to add a new property value of premium: true.</p>
		</div>
		<div class="code-block-section-w60">
			<pre
				class="example"><span class="code-nodejs">db.tours.updateMany({ price: {$gt: 500}, rating: {$gte: 4.8}}, { $set: {premium: true}})</pre>
		</div>
	</section>









	<h1>Deleting documents</h1>

	<h2>deleteOne()</h2>
	<div class="text-section">
		<p>This deletes the first document matching the query.</p>
	</div>


	<h2>deleteMany()</h2>
	<div class="text-section">
		<p>This deletes all documents matching the query.</p>
	</div>


	<section class="code-section-container">
		<div class="code-text-section">
			<p>Delete tours with rating below 4.8.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">db.tours.deleteMany({ rating: {$lt: 4.8} })</span></pre>
		</div>
	</section>


	<h2>Delete all documents</h2>
	<section class="code-section-container">
		<div class="code-text-section">
			<p>Pass in an empty objet to delete all documents.</p>
			<p>This is permanent.</p>

		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">db.tours.deleteMany({})</span></pre>
		</div>

	</section>










	<h1>Using COMPASS for CRUD operations</h1>
	<p>Compass is a GUI to work with Mongo.</p>

	<h2>Download from website.</h2>
	<div class="text-section">
		<ul>
			<li><a href="https://www.mongodb.com/products/compass" target="_blank">Download Compass</a></li>

		</ul>
	</div>

	<h2>Start the monogo server in the background</h2>

	<h2>Open Compass</h2>
	<div class="text-section">
		<p>Make sure you're on the 'New Connectin' screen.</p>
		<img src="../../_img/compass.png">
		<p>Everything should already be configured to use localhost and your mongo port.</p>
		<p>Click the 'Connect' button to load your environment.</p>
		<img src="../../_img/compass-dbs.png">
		<p>All databases are listed.</p>
	</div>

	<h2>Insert a Document</h2>
	<div class="text-section">
		<p>Click into your database.</p>
		<img src="../../_img/compass-add-data.png">
		<p>Click the 'Add Data' dropdown, then 'Insert Document'.</p>
		<img src="../../_img/compass-insert-document.png">

		<p>Add new properties and values.</p>
		<p>NOTE: You must enter it exacty as shown or it will not validate.</p>

	</div>

	<h2>Query a property</h2>
	<div class="text-section">
		<p>Use the same syntax as in the Mongo shell.</p>
		<img src="../../_img/compass-query.png">
		<p>Click the 'Options' dropdown to refine the results. This examle show the 'Project' field adding a search for the
			name. The results will then only contain the name property and no others.</p>
		<img src="../../_img/compass-query-options.png">

	</div>












	<h1>Atlas App</h1>
	<div class="text-section">
		<p>Download Atlas from the MongoDB website.</p>
		<p>Create a new Project.</p>
	</div>



	<h2>Connect Atlas to your local app</h2>
	<div class="text-section">
		<p>You must now update your application <span class="code">config.env</span> file so it can connect to Atlas.</p>
	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>Add your user Atlas cluster password to the file.</p>
		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">NODE_ENV=development
PORT=3000
DATABASE_PASSWORD=<span class="code-highlight">#######</span></span></pre>
		</div>


	</section>


	<h2>Connect Atlas to your local Compass</h2>
	<div class="text-section">
		<p>This connects Atlas to your local install of Compass.</p>
		<p>What you create in Compass will then appear in Atlas.</p>
		<p>In Atlas...</p>
		<ol>
			<li>View your list of projects.</li>
			<li>Click your project name.
				<dl>
					<dd>
						<img src="../../_img/atlas-build-a-database.png" width="500px">
					</dd>
				</dl>
			</li>
			</li>
			<li>Click the <span class="text-object">Build a Database</span> button.</li>
			<li>Click the FREE option.</li>
			<li>Choose a cluster provider. Click <span class="text-object">Create Cluster</span>.</li>
			<li>Create a username and password.</li>
			<li>Click to add your current IP address.</li>
			<li>Click <span class="text-object">Finish and Close</span>. The cluster will take a few minutes to create.</li>
			<li>After the cluster is created, click the <span class="text-object">Connect</span> button.</li>
			<li>Choose the option to connect with Compass.
				<dl>
					<dd>
						<img src="../../_img/atlas-connect-connection-string.png" width="500px">
					</dd>
				</dl>
			</li>
			<li>Copy the connection string.</li>
			<li>Open Compass. <dl>
					<dd>
						<img src="../../_img/compass-connection-string.png" width="500px">
					</dd>
				</dl>
			</li>
			<li>Enter the connection string. Make sure to update your password and database name.</li>
			<li>Click <span class="text-object">Connect</span>.</li>
			<li>After the next page loads, you'll see <span class="text-object">admin</span> and <span
					class="text-object">local</span> listed.</li>
			<li>Click <span class="text-object">Create database</span> on the top left.</li>
			<li>Add a <span class="text-object">Database Name</span> and <span class="text-object">Collection Name</span>.
			</li>
			<li>Click <span class="text-object">Create database</span>.</li>
			<li>This new database appears in the list under <span class="text-object">admin</span> and <span
					class="text-object">local</span>.</li>
			<li>Insert a document.</li>
			<li>Open Atlas in your browser.
				<dd>
					<img src="../../_img/atlas-cluster-info.png" width="500px">
				</dd>
				</dl>
			</li>
			<li>Click the <span class="text-object">Collections</span> tab to view your new database and collection.</li>
		</ol>
	</div>

	<h2>Whitelist all IP addresses</h2>
	<div class="text-section">
		<p>This allows you to work on your project for any computer.</p>
		<p>This is only useful if the database contains NO sensitive information.</p>

		<ol>
			<li>Open Atlas in your browser.</li>
			<li>On the left, click <span class="text-object">Network Access</span>.</li>
			<li>On the top right click <span class="text-object">+ ADD IP ADDRESS</span>.
				<dl>
					<dd>
						<img src="../../_img/atlas-network-access.png" width="500px">
					</dd>
				</dl>
			</li>
			<li>Click the button <span class="text-object">Allow Access from Anywhere</span>, then click <span
					class="text-object">Confirm</span>.</li>

		</ol>
	</div>






	<h2>Connect Atlas with your Mongo Shell</h2>
	<div class="text-section">
		<p>This connects Atlas with your local Mongo Shell environment.</p>

		<ol>
			<li>Open Atlas in your browser.
				<dl>
					<dd>
						<img src="../../_img/atlas-connect.png" width="500px">
					</dd>
				</dl>
			</li>
			<li>On the next popup click <span class="text-object">Connect with the MongoDB Shell</span>.
				<dl>
					<dd>
						<img src="../../_img/atlas-connect-connection-string-shell.png" width="500px">
					</dd>
				</dl>

			</li>
			<li>Copy the connection string.</li>
			<li>Open your terminal. Make sure a Mongo Shell is not already running. If so, type in <span
					class="code">quit()</span> to return to the Shell.</li>
			<li>Paste in your new mongo string. NOTE: Change <span class="code">mongosh</span> at the beginning of the string
				to <span class="code">mongo</span>.</li>
			<li>Enter your user password.</li>
			<li>View your databases: <span class="code">show dbs</span>.</li>
			<li>Switch to it: <span class="code">use natours</span>.</li>
			<li>View the document you previously created: <span class="code">db.tours.find()</span>.</li>

		</ol>
	</div>





	<h2>Connect your app to Atlas</h2>

	<div class="text-section">
		<p>This connects Atlas with your local app.</p>

		<ol>
			<li>Open Atlas in your browser.
				<dl>
					<dd>
						<img src="../../_img/atlas-connect.png" width="500px">
					</dd>
				</dl>
			</li>
			<li>On the next popup click <span class="text-object">Connect your application</span>.

			</li>
			<li>Make sure the <span class="text-object">Driver</span> dropdown is set to <span
					class="text-object">Node.js</span>.</li>
			<li> Copy the connection string.</li>
			<li>

				<section class="code-section-container">
					<div class="code-text-section">
						<p>Update the password field. You could also leave it as <span class="code">&lt;PASSWORD&gt;</span> The
							<span class="code">server.js</span> file would then use the enviornmental variable from <span
								class="text-object">config.env</span> to fill it in.
						</p>
						<p>Change <span class="code">myFirstDatabse</span> to the database name in Compass.</p>
					</div>
					<div class="code-block-section-w60">
						<pre class="example"><span class="code-nodejs">NODE_ENV=development
PORT=3000
<span class="code-highlight">DATABASE=mongodb+srv://cjdh22:password@cluster0.8y3ej.mongodb.net/myFirstDatabase?retryWrites=true&w=majority</span>
DATABASE_PASSWORD=password</span></pre>
					</div>
				</section>

				<section class="code-section-container">
					<div class="code-text-section">
						<p>If you want to use your local database instead of Atlas, use this connection string instead.</p>
						<p>NOTE: The local mongo server must be running for the connection to work.</p>
					</div>
					<div class="code-block-section-w60">
						<pre class="example"><span class="code-nodejs">NODE_ENV=development
PORT=3000
<span class="code-highlight">DATABASE_LOCAL=mongodb://localhost:27017/databasename</span>
DATABASE_PASSWORD=password</span></pre>
					</div>
				</section>
			</li>

		</ol>
	</div>







	<h1>Mongoose</h1>




























	<h2>Install Mongoose</h2>
	<div class="text-section">
		<p>Install Mongoose in your Node.js application.</p>
		<p><span class="code">npm i mongoose</span></p>
	</div>



	<h2>Configure server.js to use Mongoose to connect to Atlas database</h2>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>Add a variable to store mongoose.</p>
			<p>Repace the password in the database string with the password variable in the <span
					class="text-object">config.env</span> file.</p>
			<p>Create a connection to the database using <span class="code">mongoose.connect()</span>.</p>
			<p>Run <span class="code">npm start</span> to run the file. You should see the success message.</p>


		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs"><span class="code-highlight">const mongoose = require('mongoose');</span>
const dotenv = require('dotenv');
const app = require('./app');

dotenv.config({ path: './config.env' });

<span class="code-comment">// process.env.DATABASE is the variable in the config.env file
// This replaces the password variable in the connection string with the real password from the password variable</span>
<span class="code-highlight">const DB = process.env.DATABASE.replace('<PASSWORD>', process.env.DATABASE_PASSWORD);</span>

<span class="code-comment">// pass in database connection string
// then pass in an Object with some options (these deal with deprecation warnings)
// This connection returns a promise. Handle it using then()
// This gives you access to a connection Object</span>
<span class="code-highlight">mongoose.connect(DB, {
  useNewUrlParser: true,
  useCreateIndex: true,
  useFindAndModify: false
  }) <span class="code-comment">// this connection will be the resolved value of the Promise</span>
  .then(() => console.log('DB connection successful'));</span>

const port = process.env.PORT || 3000;
app.listen(port, () => {
	console.log(`App running on port ${port}...`);
});</span></pre>
		</div>
	</section>




	<h2>Configure server.js to use Mongoose to connect to local database</h2>
	<div class="text-section">
		<p>This is if you choose to not use Atlas to host the database and want it hosted locally.</p>
	</div>

	<section class="code-section-container">
		<div class="code-text-section">
			<p>Same as above, but you would change the database connection to <span
					class="code">process.env.DATABASE_LOCAL</span>.</p>
			<p>This variable is set in the <span class="text-object">config.env</span> file.</p>


		</div>
		<div class="code-block-section-w60">
			<pre class="example"><span class="code-nodejs">const mongoose = require('mongoose');
const dotenv = require('dotenv');
const app = require('./app');

dotenv.config({ path: './config.env' });


const DB = process.env.DATABASE.replace('<PASSWORD>', process.env.DATABASE_PASSWORD);

mongoose.connect(<span class="code-highlight">process.env.DATABASE_LOCAL,</span>  {
  useNewUrlParser: true,
  useCreateIndex: true,
  useFindAndModify: false
  })
  .then(() => console.log('DB connection successful'));

const port = process.env.PORT || 3000;
app.listen(port, () => {
	console.log(`App running on port ${port}...`);
});</span></pre>
		</div>
	</section>





























</body>

</html>